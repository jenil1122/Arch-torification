name: Publish to AUR

on:
  push:
    branches:
      - master  # Trigger on any commit to the master branch

jobs:
  aur:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt install -y git build-essential

      - name: Configure SSH and clone AUR repository
        run: |
          mkdir -p ~/.ssh
          if [ ! -f ~/.ssh/arch-torification ]; then
            echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCpXc4NJRhwmHwFG9k8QWcN1vFFtcwskI+RoNBkN8IwB3EidmaAOTMv7sz6CeXCW+ALn0kXHwauX6t4Hns8j3FIh0QZh8itdQkiV0KQcfb+sRnCk6WMGH1eI1VJNnEHgU2KmE9OrE8eENeOqKOLY5Qb3c/YbROdylcTFfHx/X5+3Xmi4Xcsy+v3xwox743RgxziDH8ALGS8jV6P7LI1W+IhmtuU2IEYaN5w3Qsh3viASBdx2vHkCDxvGUWq9V65u2P560Hw6LbCfzJlhLZ9O3xb266jKIPJthMDcxVDx+5q4/XSv8HRbfDIiH5XSMvrYUTqwhaoEiX0pdq5bbj6lWHhlH6owyKf2/v1Q4kLeUS3HtuiORieuZStWBJEyszc6Yg6RznUs7UGgrmNur6lwy/BnfE04bkjsfOVFdL1Hg/5cM7mLFY+kl2o7c79fGatpXXU6cogFzu5VY6DibwDzvo+D+v3NzXRDePVWyBGYQpVKiiMjxXPWO/2MH8ft483Q5PFMP361aTx3MAjmSPesuso3m6NN8TaN2Xvu2xF67RBkU1xka9At/nXR2WJvfI/NLlHIUvHIYipx1MTmk3/oSNjvpckRwhF8Q7LF9sWKMmeq+4qWAhbcllzKqwyrrTfc5Zj/YkMjgRhbsY4I9NY+Lb4CRvu2hBE69TFZoJe/x8COw== > ~/.ssh/arch-torification
            chmod 600 ~/.ssh/arch-torification
          fi
          echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCpXc4NJRhwmHwFG9k8QWcN1vFFtcwskI+RoNBkN8IwB3EidmaAOTMv7sz6CeXCW+ALn0kXHwauX6t4Hns8j3FIh0QZh8itdQkiV0KQcfb+sRnCk6WMGH1eI1VJNnEHgU2KmE9OrE8eENeOqKOLY5Qb3c/YbROdylcTFfHx/X5+3Xmi4Xcsy+v3xwox743RgxziDH8ALGS8jV6P7LI1W+IhmtuU2IEYaN5w3Qsh3viASBdx2vHkCDxvGUWq9V65u2P560Hw6LbCfzJlhLZ9O3xb266jKIPJthMDcxVDx+5q4/XSv8HRbfDIiH5XSMvrYUTqwhaoEiX0pdq5bbj6lWHhlH6owyKf2/v1Q4kLeUS3HtuiORieuZStWBJEyszc6Yg6RznUs7UGgrmNur6lwy/BnfE04bkjsfOVFdL1Hg/5cM7mLFY+kl2o7c79fGatpXXU6cogFzu5VY6DibwDzvo+D+v3NzXRDePVWyBGYQpVKiiMjxXPWO/2MH8ft483Q5PFMP361aTx3MAjmSPesuso3m6NN8TaN2Xvu2xF67RBkU1xka9At/nXR2WJvfI/NLlHIUvHIYipx1MTmk3/oSNjvpckRwhF8Q7LF9sWKMmeq+4qWAhbcllzKqwyrrTfc5Zj/YkMjgRhbsY4I9NY+Lb4CRvu2hBE69TFZoJe/x8COw== > ~/.ssh/arch-torification
          chmod 600 ~/.ssh/arch-torification

          eval "$(ssh-agent -s)"
          cat ~/.ssh/arch-torification
          ssh-add ~/.ssh/arch-torification
          mkdir -p test
          cd test
          git clone ssh://aur@aur.archlinux.org/arch-torification.git

      - name: Copy PKGBUILD and generate .SRCINFO
        run: |
          cp PKGBUILD test/arch-torification/
          cd test/arch-torification
          makepkg --printsrcinfo > .SRCINFO

      - name: Commit and push changes to AUR
        run: |
          cd test/arch-torification
          git add PKGBUILD .SRCINFO
          git commit -m "Update PKGBUILD for version ${{ github.event.release.tag_name }}"
          git push

      - name: Clean up
        run: rm -rf test
