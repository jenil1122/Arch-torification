name: Pkgbuild Updater

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Run Docker
        run: |
          docker pull archlinux
          docker run -d --name arch-container archlinux tail -f /dev/null

      - name: Decrypt SSH Key and Clone Repository
        env:
          SSH_KEY_PASSWORD: ${{ secrets.ENCRYPTION_PASSWORD }}
          ENCRYPTED_PUBLIC_KEY_BASE64: ${{ secrets.ENCRYPTED_JENIL_PUB }}
        run: |
          docker exec arch-container bash -c '
            mkdir -p /.ssh && 
            echo "${ENCRYPTED_PUBLIC_KEY_BASE64// /}" | base64 --decode > /.ssh/arch.pub.enc && 
            openssl aes-256-cbc -d -in /.ssh/arch.pub.enc -out /.ssh/arch.pub -pass pass:"$SSH_KEY_PASSWORD" -pbkdf2 && 
            chmod 600 /.ssh/arch.pub && 
            useradd -m -G wheel arch-torification && 
            if grep -q "^#.*%wheel.*ALL=(ALL:ALL).*ALL" /etc/sudoers; then 
              sed -i "/^#.*%wheel.*ALL=(ALL:ALL).*ALL/s/^#//" /etc/sudoers && 
              echo "Uncommented %wheel ALL=(ALL:ALL) ALL in sudoers file."; 
            else 
              echo "%wheel ALL=(ALL:ALL) ALL is already uncommented in sudoers file."; 
            fi && 
            cat /.ssh/arch.pub 
            eval "$(ssh-agent)" 
            ssh-add /.ssh/arch.pub 
            git clone ssh://aur@aur.archlinux.org/arch-torification.git'
        shell: /usr/bin/bash -e {0}
